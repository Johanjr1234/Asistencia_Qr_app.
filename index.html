<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Asistencia QR Pro V4</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; height: 100vh; overflow: hidden; }
        
        .tab-content { display: none; height: 100%; overflow-y: auto; padding-bottom: 100px; }
        .tab-content.active { display: block; }

        /* ESTILOS DEL CARNET (Clase Maestra) */
        /* Definimos medidas exactas que no dependen de la pantalla */
        .master-card {
            width: 320px;
            height: 540px;
            background: white;
            position: relative;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            display: flex;
            flex-col: column;
            align-items: center;
        }

        .card-header {
            background: linear-gradient(180deg, #2563eb 0%, #1d4ed8 100%);
            height: 160px;
            width: 100%;
            position: absolute;
            top: 0; left: 0;
            border-bottom-left-radius: 25px;
            border-bottom-right-radius: 25px;
            z-index: 0;
        }

        /* Contenedor fantasma para exportación (Invisible para el usuario, visible para html2canvas) */
        #export-container {
            position: fixed;
            top: -9999px;
            left: -9999px;
            z-index: -1;
        }

        /* Ajustes específicos para que el texto no se corte */
        .text-fix { white-space: nowrap; overflow: visible; }
        
        /* Iframe oculto para imprimir */
        #print-frame { display: none; }
    </style>
</head>
<body class="flex flex-col text-gray-800">

    <div id="login-view" class="absolute inset-0 z-50 flex items-center justify-center bg-gray-100 p-4">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm border border-gray-100">
            <div class="text-center mb-6">
                <div class="bg-blue-600 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-qrcode text-3xl text-white"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-800">Acceso Seguro</h1>
            </div>
            <form id="login-form" class="space-y-4">
                <input type="text" id="username" class="w-full px-4 py-3 bg-gray-50 border rounded-xl outline-none" placeholder="Usuario">
                <input type="password" id="password" class="w-full px-4 py-3 bg-gray-50 border rounded-xl outline-none" placeholder="Contraseña">
                <div id="login-error" class="hidden text-red-500 text-xs text-center">Credenciales incorrectas</div>
                <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold">Ingresar</button>
            </form>
            <p id="db-status" class="mt-4 text-center text-xs text-gray-400">Conectando...</p>
        </div>
    </div>

    <div id="app-view" class="hidden flex-col h-full w-full">
        <header class="bg-white border-b px-4 py-3 flex justify-between items-center z-20 shadow-sm shrink-0">
            <h1 class="font-bold text-gray-800">Asistencia V4</h1>
            <button onclick="logout()" class="text-gray-400"><i class="fas fa-power-off"></i></button>
        </header>

        <main class="flex-1 overflow-hidden relative bg-gray-50">
            
            <div id="tab-generar" class="tab-content active">
                <div class="max-w-xl mx-auto p-4 space-y-6">
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                        <h2 class="text-sm font-bold text-gray-700 mb-4 border-b pb-2">Datos del Usuario</h2>
                        <form id="carnet-form" class="space-y-3">
                            <div class="grid grid-cols-2 gap-3">
                                <input type="number" id="inp-id" required class="p-2 border rounded bg-gray-50 text-sm" placeholder="ID / Documento">
                                <select id="inp-role" class="p-2 border rounded bg-gray-50 text-sm">
                                    <option value="ESTUDIANTE">ESTUDIANTE</option>
                                    <option value="PROFESOR">PROFESOR</option>
                                    <option value="ADMINISTRATIVO">ADMINISTRATIVO</option>
                                </select>
                            </div>
                            <input type="text" id="inp-name" required class="w-full p-2 border rounded bg-gray-50 text-sm" placeholder="Nombre Completo">
                            <div class="grid grid-cols-2 gap-3">
                                <input type="text" id="inp-residence" class="p-2 border rounded bg-gray-50 text-sm" placeholder="Sede / Ciudad">
                                <input type="file" id="inp-photo" accept="image/*" class="text-xs text-gray-500">
                            </div>
                            <button type="button" onclick="updatePreview()" class="w-full bg-blue-600 text-white py-2 rounded font-bold text-sm mt-2">
                                <i class="fas fa-sync mr-1"></i> Actualizar Vista
                            </button>
                        </form>
                    </div>

                    <div class="flex flex-col items-center">
                        <div class="transform scale-[0.85] origin-top">
                            <div id="preview-card" class="master-card">
                                <div class="card-header"></div>
                                <div class="relative z-10 flex flex-col items-center w-full h-full pt-8">
                                    <h3 class="text-white text-xs font-bold tracking-[0.2em] uppercase opacity-90 mb-6">IDENTIFICACIÓN DIGITAL</h3>
                                    
                                    <div class="w-36 h-36 rounded-full p-1 bg-white shadow-lg z-20 mb-4">
                                        <img id="card-img" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' class='h-full w-full text-gray-300' fill='currentColor' viewBox='0 0 24 24'%3E%3Cpath d='M24 20.993V24H0v-2.996A14.977 14.977 0 0112.004 15c4.904 0 9.26 2.354 11.996 5.993zM16.002 8.999a4 4 0 11-8 0 4 4 0 018 0z' /%3E%3C/svg%3E" class="w-full h-full rounded-full object-cover bg-gray-100">
                                    </div>

                                    <div class="text-center w-full px-4 mb-2">
                                        <h2 id="card-name" class="text-xl font-bold text-gray-900 leading-tight text-fix pb-1">Nombre Usuario</h2>
                                        <div class="mt-2">
                                            <span id="card-role" class="bg-blue-100 text-blue-800 text-xs px-4 py-1.5 rounded-full uppercase font-bold tracking-wide">ROL</span>
                                        </div>
                                    </div>

                                    <div class="flex justify-between w-full px-10 text-center mt-4 mb-4">
                                        <div>
                                            <p class="text-[10px] text-gray-400 uppercase font-bold">ID Número</p>
                                            <p id="card-id" class="font-mono text-gray-800 font-bold text-lg">-</p>
                                        </div>
                                        <div>
                                            <p class="text-[10px] text-gray-400 uppercase font-bold">Sede</p>
                                            <p id="card-residence" class="text-gray-800 font-bold text-lg">-</p>
                                        </div>
                                    </div>

                                    <div class="mt-auto mb-8 bg-white p-2 rounded-xl border shadow-sm">
                                        <div id="card-qrcode"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="action-buttons" class="hidden flex gap-3 w-full max-w-xs mt-[-40px]">
                            <button onclick="handlePrint()" class="flex-1 bg-gray-800 text-white py-3 rounded-full shadow-lg font-bold text-sm flex items-center justify-center gap-2">
                                <i class="fas fa-print"></i> Imprimir
                            </button>
                            <button onclick="handleDownload()" class="flex-1 bg-green-600 text-white py-3 rounded-full shadow-lg font-bold text-sm flex items-center justify-center gap-2">
                                <i class="fas fa-download"></i> Guardar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-gestionar" class="tab-content">
                <div class="max-w-xl mx-auto p-4">
                    <div class="bg-white rounded-xl shadow-sm border p-4">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="font-bold">Usuarios</h2>
                            <input type="text" id="search-input" onkeyup="filterUsers()" placeholder="Buscar..." class="border rounded px-2 py-1 text-sm">
                        </div>
                        <table class="w-full text-left text-sm">
                            <tbody id="users-table-body">
                                <tr><td class="text-center text-gray-400">Cargando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="tab-asistencia" class="tab-content">
                <div class="max-w-md mx-auto p-4 space-y-4">
                    <div class="bg-white rounded-xl shadow border p-4">
                        <div id="reader" class="w-full h-64 bg-black rounded-lg overflow-hidden"></div>
                        <div id="scan-result" class="hidden mt-2 p-2 rounded text-center font-bold text-sm"></div>
                    </div>
                    <div class="flex gap-2">
                        <input type="number" id="manual-id" placeholder="ID Manual" class="flex-1 border rounded p-2 text-center">
                        <button onclick="manualAttendance()" class="bg-gray-800 text-white px-4 rounded"><i class="fas fa-check"></i></button>
                    </div>
                    <ul id="attendance-list" class="bg-white rounded-xl shadow border p-2 h-48 overflow-y-auto"></ul>
                </div>
            </div>

        </main>

        <nav class="bg-white border-t flex justify-around p-2 fixed bottom-0 left-0 w-full z-40 shadow-lg h-[70px]">
            <button onclick="switchTab('tab-generar')" class="nav-btn w-full text-blue-600 flex flex-col items-center justify-center" data-target="tab-generar">
                <i class="fas fa-id-card text-xl"></i><span class="text-[10px] font-bold mt-1">Carnet</span>
            </button>
            <button onclick="switchTab('tab-gestionar')" class="nav-btn w-full text-gray-400 flex flex-col items-center justify-center" data-target="tab-gestionar">
                <i class="fas fa-users-cog text-xl"></i><span class="text-[10px] font-bold mt-1">Gestor</span>
            </button>
            <button onclick="switchTab('tab-asistencia')" class="nav-btn w-full text-gray-400 flex flex-col items-center justify-center" data-target="tab-asistencia">
                <i class="fas fa-qrcode text-xl"></i><span class="text-[10px] font-bold mt-1">Scan</span>
            </button>
        </nav>
    </div>

    <div id="export-container"></div>
    
    <iframe id="print-frame"></iframe>

    <div id="toast" class="hidden fixed top-5 right-5 z-[100] bg-gray-900 text-white px-4 py-3 rounded-lg shadow-2xl flex items-center gap-3">
        <i id="toast-icon" class="fas fa-info-circle"></i>
        <span id="toast-message" class="text-xs">Mensaje</span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, deleteDoc, doc, orderBy, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuración Firebase
        const app = initializeApp({
            apiKey: "AIzaSyBo9YlpqRx04DmnGEZ7sw5M07AGyC7eRG4",
            authDomain: "app-asistecia-qr.firebaseapp.com",
            projectId: "app-asistecia-qr",
            storageBucket: "app-asistecia-qr.firebasestorage.app",
            messagingSenderId: "1001987551868",
            appId: "1:1001987551868:web:f1d409d7cfaf962ea90ff9"
        });
        const auth = getAuth(app);
        const db = getFirestore(app);
        const APP_ID = "asistencia-v4";

        let allStudents = [];
        let html5QrcodeScanner = null;
        let scanCooldown = false;
        let photoBase64 = "";

        // --- AUTH ---
        signInAnonymously(auth).then(() => {
            document.getElementById('db-status').innerText = "● Online";
            document.getElementById('db-status').classList.add("text-green-500", "font-bold");
            loadData();
        });

        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            if(document.getElementById('username').value === 'admin' && document.getElementById('password').value === '1234') {
                document.getElementById('login-view').classList.add('hidden');
                document.getElementById('app-view').classList.remove('hidden');
                document.getElementById('app-view').classList.add('flex');
            } else {
                document.getElementById('login-error').classList.remove('hidden');
            }
        });

        window.logout = () => location.reload();
        window.switchTab = (id) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(el => {
                el.classList.toggle('text-blue-600', el.dataset.target === id);
                el.classList.toggle('text-gray-400', el.dataset.target !== id);
            });
            if(id === 'tab-asistencia') startScanner(); else stopScanner();
        };

        // --- LÓGICA DEL CARNET ---
        document.getElementById('inp-photo').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(file) {
                const reader = new FileReader();
                reader.onloadend = () => {
                    photoBase64 = reader.result;
                    document.getElementById('card-img').src = photoBase64;
                };
                reader.readAsDataURL(file);
            }
        });

        // Esta función solo actualiza la vista en pantalla (preview)
        window.updatePreview = () => {
            const id = document.getElementById('inp-id').value;
            const name = document.getElementById('inp-name').value;
            if(!id || !name) return showToast("Faltan datos", "error");

            // Actualizar textos
            document.getElementById('card-name').innerText = name;
            document.getElementById('card-role').innerText = document.getElementById('inp-role').value;
            document.getElementById('card-id').innerText = id;
            document.getElementById('card-residence').innerText = document.getElementById('inp-residence').value || "Sede Principal";

            // Generar QR en el preview visible
            document.getElementById('card-qrcode').innerHTML = "";
            new QRCode(document.getElementById('card-qrcode'), {
                text: id, width: 90, height: 90, colorDark: "#1d4ed8", correctLevel: QRCode.CorrectLevel.H
            });

            document.getElementById('action-buttons').classList.remove('hidden');
            document.getElementById('action-buttons').classList.add('flex');
        };

        // --- SOLUCIÓN DE DESCARGA E IMPRESIÓN (CLON FANTASMA) ---
        async function generateCleanCanvas() {
            // 1. Clonar el carnet original
            const original = document.getElementById('preview-card');
            const clone = original.cloneNode(true);
            
            // 2. Colocarlo en el contenedor invisible
            const container = document.getElementById('export-container');
            container.innerHTML = "";
            container.appendChild(clone);

            // 3. Forzar el tamaño exacto en el clon (para eliminar el efecto de zoom del celular)
            clone.style.transform = "none"; 
            clone.style.margin = "0";
            
            // 4. Asegurarnos que la imagen y QR se carguen
            // (El QR clonado a veces pierde el contenido canvas, así que lo regeneramos)
            const qrDiv = clone.querySelector('#card-qrcode');
            qrDiv.innerHTML = "";
            new QRCode(qrDiv, {
                text: document.getElementById('card-id').innerText,
                width: 90, height: 90, colorDark: "#1d4ed8", correctLevel: QRCode.CorrectLevel.H
            });

            // 5. Esperar un momento a que renderice
            await new Promise(r => setTimeout(r, 300));

            // 6. Capturar con alta calidad
            return await html2canvas(clone, {
                scale: 3, // Alta resolución
                useCORS: true,
                backgroundColor: "#ffffff",
                logging: false
            });
        }

        window.handleDownload = async () => {
            showToast("Procesando...", "info");
            const canvas = await generateCleanCanvas();
            const link = document.createElement('a');
            link.download = `Carnet_${document.getElementById('card-id').innerText}.png`;
            link.href = canvas.toDataURL("image/png");
            link.click();
            document.getElementById('export-container').innerHTML = ""; // Limpiar
            // Guardar en BD también si se desea...
            saveStudentToDB(); 
        };

        window.handlePrint = async () => {
            showToast("Preparando impresión...", "info");
            const canvas = await generateCleanCanvas();
            const imgData = canvas.toDataURL("image/png");
            
            // Truco del Iframe para imprimir en móviles
            const iframe = document.getElementById('print-frame');
            const doc = iframe.contentWindow.document;
            
            doc.open();
            doc.write(`
                <html>
                <head><title>Imprimir Carnet</title></head>
                <body style="display:flex; justify-content:center; align-items:center; height:100vh; margin:0;">
                    <img src="${imgData}" style="max-width:100%; max-height:100vh; border:1px dashed #ccc;">
                    <script>
                        // Esperar a que la imagen cargue y lanzar print
                        window.onload = function() { setTimeout(() => { window.print(); }, 500); }
                    <\/script>
                </body>
                </html>
            `);
            doc.close();
            document.getElementById('export-container').innerHTML = ""; // Limpiar
        };

        async function saveStudentToDB() {
            try {
                const id = document.getElementById('inp-id').value;
                // Verificar duplicados simple
                if(allStudents.some(s => s.id_card == id)) return;
                
                await addDoc(collection(db, 'artifacts', APP_ID, 'students'), {
                    id_card: id,
                    name: document.getElementById('inp-name').value,
                    role: document.getElementById('inp-role').value,
                    photo: photoBase64,
                    createdAt: serverTimestamp()
                });
                showToast("Guardado en BD", "success");
            } catch(e) { console.error(e); }
        }

        // --- GESTIÓN DATOS ---
        function loadData() {
            onSnapshot(collection(db, 'artifacts', APP_ID, 'students'), (snap) => {
                allStudents = [];
                const tbody = document.getElementById('users-table-body');
                tbody.innerHTML = "";
                snap.forEach(d => {
                    const s = d.data();
                    allStudents.push(s);
                    tbody.innerHTML += `
                        <tr class="border-b">
                            <td class="p-3">
                                <div class="font-bold">${s.name}</div>
                                <div class="text-xs text-gray-500">${s.role} - ${s.id_card}</div>
                            </td>
                            <td class="p-3 text-right text-red-500 cursor-pointer" onclick="deleteUser('${d.id}')">
                                <i class="fas fa-trash"></i>
                            </td>
                        </tr>`;
                });
            });
            // Asistencia...
            onSnapshot(query(collection(db, 'artifacts', APP_ID, 'attendance'), orderBy('timestamp', 'desc'), limit(20)), (snap) => {
                const list = document.getElementById('attendance-list');
                list.innerHTML = "";
                snap.forEach(d => {
                    const a = d.data();
                    list.innerHTML += `<li class="p-2 border-b text-xs flex justify-between">
                        <span><b>${a.studentName}</b></span>
                        <span class="text-blue-600">${a.timestamp?.toDate().toLocaleTimeString() || ''}</span>
                    </li>`;
                });
            });
        }

        window.filterUsers = () => {
            const term = document.getElementById('search-input').value.toLowerCase();
            const rows = document.querySelectorAll('#users-table-body tr');
            rows.forEach(row => {
                const text = row.innerText.toLowerCase();
                row.style.display = text.includes(term) ? '' : 'none';
            });
        };

        window.deleteUser = async (id) => {
            if(confirm("Borrar?")) await deleteDoc(doc(db, 'artifacts', APP_ID, 'students', id));
        };

        // --- SCANNER ---
        function startScanner() {
            if(html5QrcodeScanner) return;
            html5QrcodeScanner = new Html5Qrcode("reader");
            html5QrcodeScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, async (code) => {
                if(scanCooldown) return;
                scanCooldown = true;
                const student = allStudents.find(s => s.id_card == code);
                const div = document.getElementById('scan-result');
                div.classList.remove('hidden');
                
                if(student) {
                    div.innerHTML = `✅ ${student.name}`;
                    div.className = "mt-2 p-2 rounded text-center font-bold text-sm bg-green-100 text-green-700";
                    await addDoc(collection(db, 'artifacts', APP_ID, 'attendance'), {
                        studentId: code, studentName: student.name, timestamp: serverTimestamp()
                    });
                } else {
                    div.innerHTML = `❌ Desconocido`;
                    div.className = "mt-2 p-2 rounded text-center font-bold text-sm bg-red-100 text-red-700";
                }
                setTimeout(() => { scanCooldown = false; div.classList.add('hidden'); }, 2000);
            });
        }
        function stopScanner() {
            if(html5QrcodeScanner) { html5QrcodeScanner.stop(); html5QrcodeScanner = null; }
        }
        window.manualAttendance = () => {
            // Lógica manual... (reutilizar la lógica del scanner si se desea)
        }

        // --- UTILS ---
        function showToast(msg, type) {
            const t = document.getElementById('toast');
            t.querySelector('#toast-message').innerText = msg;
            t.classList.remove('hidden');
            setTimeout(() => t.classList.add('hidden'), 3000);
        }
    </script>
</body>
</html>
                        

        
        
