    <!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistencia QR Pro</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Iconos -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Librerías Externas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <!-- Fuente -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Estilos del Carnet para captura */
        #id-card-preview {
            width: 320px;
            height: 500px;
            background: white;
            position: relative;
            overflow: hidden;
            border-radius: 16px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        
        /* Diseño de fondo del carnet */
        .card-header-bg {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            height: 140px;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 0;
            border-bottom-left-radius: 50% 20%;
            border-bottom-right-radius: 50% 20%;
        }

        /* Scanner container */
        #reader { width: 100%; border-radius: 12px; overflow: hidden; }

        /* Loader */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="h-screen flex flex-col">

    <!-- LOGIN SCREEN -->
    <div id="login-view" class="flex-1 flex items-center justify-center bg-gray-100 p-4 z-50">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md">
            <div class="text-center mb-6">
                <div class="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-shield-alt text-2xl text-blue-600"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-800">Acceso Seguro</h1>
                <p class="text-gray-500 text-sm">Sistema de Asistencia QR</p>
            </div>
            
            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Usuario</label>
                    <input type="text" id="username" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="admin">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Contraseña</label>
                    <input type="password" id="password" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="••••">
                </div>
                <div id="login-error" class="text-red-500 text-sm text-center hidden">Credenciales incorrectas</div>
                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700 transition shadow-lg">
                    Ingresar
                </button>
            </form>
            <div class="mt-4 text-center">
                <p id="db-status" class="text-xs text-gray-400"><i class="fas fa-circle-notch fa-spin"></i> Conectando a Firebase...</p>
            </div>
        </div>
    </div>

    <!-- APP SCREEN -->
    <div id="app-view" class="hidden flex-1 flex flex-col h-full overflow-hidden">
        
        <!-- Header -->
        <header class="bg-white shadow-sm px-4 py-3 flex justify-between items-center z-10">
            <h1 class="text-lg font-bold text-gray-800"><i class="fas fa-qrcode text-blue-600 mr-2"></i>Asistencia QR</h1>
            <button onclick="logout()" class="text-gray-500 hover:text-red-500"><i class="fas fa-sign-out-alt"></i></button>
        </header>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto p-4 relative">
            
            <!-- SECTION: GENERAR CARNET -->
            <div id="tab-generar" class="tab-content active max-w-4xl mx-auto">
                <div class="grid md:grid-cols-2 gap-8">
                    <!-- Formulario -->
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <h2 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2">Datos del Usuario</h2>
                        <form id="carnet-form" class="space-y-3">
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="text-xs font-bold text-gray-500">ID / DNI</label>
                                    <input type="text" id="inp-id" required class="w-full p-2 border rounded bg-gray-50 text-sm" placeholder="12345678">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-gray-500">Rol</label>
                                    <select id="inp-role" class="w-full p-2 border rounded bg-gray-50 text-sm">
                                        <option value="Estudiante">Estudiante</option>
                                        <option value="Profesor">Profesor</option>
                                        <option value="Staff">Staff</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label class="text-xs font-bold text-gray-500">Nombre Completo</label>
                                <input type="text" id="inp-name" required class="w-full p-2 border rounded bg-gray-50 text-sm" placeholder="Juan Pérez">
                            </div>

                            <div>
                                <label class="text-xs font-bold text-gray-500">Residencia</label>
                                <input type="text" id="inp-residence" class="w-full p-2 border rounded bg-gray-50 text-sm" placeholder="Ciudad / Dirección">
                            </div>

                            <div>
                                <label class="text-xs font-bold text-gray-500">Vencimiento</label>
                                <input type="date" id="inp-expiry" class="w-full p-2 border rounded bg-gray-50 text-sm">
                            </div>

                            <div>
                                <label class="text-xs font-bold text-gray-500">Foto de Perfil</label>
                                <input type="file" id="inp-photo" accept="image/*" class="w-full text-xs text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                            </div>

                            <div class="pt-4 flex gap-2">
                                <button type="button" onclick="previewCard()" class="flex-1 bg-gray-800 text-white py-2 rounded hover:bg-gray-900 text-sm">
                                    <i class="fas fa-eye mr-1"></i> Previsualizar
                                </button>
                                <button type="submit" class="flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700 text-sm shadow">
                                    <i class="fas fa-save mr-1"></i> Guardar
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Visualización Carnet -->
                    <div class="flex flex-col items-center justify-center">
                        <div id="id-card-wrap" class="mb-4 transform scale-90 md:scale-100 transition-transform origin-top">
                            <!-- El Carnet HTML -->
                            <div id="id-card-preview">
                                <div class="card-header-bg"></div>
                                
                                <div class="relative z-10 flex flex-col items-center pt-8 h-full">
                                    <!-- Titulo -->
                                    <h3 class="text-white text-lg font-bold tracking-widest uppercase opacity-90 mb-4">Credencial</h3>
                                    
                                    <!-- Foto -->
                                    <div class="w-32 h-32 rounded-full border-4 border-white shadow-lg overflow-hidden bg-gray-200">
                                        <img id="card-img" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' class='h-full w-full text-gray-400' fill='currentColor' viewBox='0 0 24 24'%3E%3Cpath d='M24 20.993V24H0v-2.996A14.977 14.977 0 0112.004 15c4.904 0 9.26 2.354 11.996 5.993zM16.002 8.999a4 4 0 11-8 0 4 4 0 018 0z' /%3E%3C/svg%3E" class="w-full h-full object-cover">
                                    </div>

                                    <!-- Nombre y Rol -->
                                    <div class="text-center mt-4 w-full px-4">
                                        <h2 id="card-name" class="text-xl font-bold text-gray-800 truncate">Nombre Usuario</h2>
                                        <span id="card-role" class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full uppercase tracking-wide font-semibold mt-1">ROL</span>
                                    </div>

                                    <!-- Detalles -->
                                    <div class="mt-6 text-center text-sm text-gray-600 space-y-1">
                                        <p>ID: <span id="card-id" class="font-mono font-bold text-gray-800">00000000</span></p>
                                        <p>Residencia: <span id="card-residence">-</span></p>
                                        <p class="text-xs text-red-500 mt-1">Vence: <span id="card-expiry">--/--/----</span></p>
                                    </div>

                                    <!-- QR Code -->
                                    <div class="mt-auto mb-6 bg-white p-2 rounded shadow-sm border">
                                        <div id="card-qrcode"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <button onclick="downloadCardImage()" id="btn-download" class="hidden bg-green-600 text-white px-6 py-2 rounded-full shadow-lg hover:bg-green-700 transition">
                            <i class="fas fa-download mr-2"></i> Descargar JPG
                        </button>
                    </div>
                </div>
            </div>

            <!-- SECTION: GESTIONAR -->
            <div id="tab-gestionar" class="tab-content max-w-4xl mx-auto">
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                        <h2 class="font-semibold text-gray-700">Lista de Carnets</h2>
                        <span id="user-count" class="text-xs bg-gray-200 px-2 py-1 rounded">0 usuarios</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm text-gray-600">
                            <thead class="bg-gray-100 text-gray-700 uppercase text-xs">
                                <tr>
                                    <th class="p-4">Usuario</th>
                                    <th class="p-4">ID</th>
                                    <th class="p-4">Rol</th>
                                    <th class="p-4 text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body">
                                <!-- Filas dinámicas aquí -->
                                <tr><td colspan="4" class="p-4 text-center">Cargando datos...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- SECTION: ASISTENCIA -->
            <div id="tab-asistencia" class="tab-content max-w-md mx-auto">
                
                <div class="bg-white rounded-xl shadow-sm p-4 mb-4">
                    <h2 class="text-center font-bold text-gray-800 mb-2">Escanear QR</h2>
                    <div id="reader" class="bg-black text-white h-64 flex items-center justify-center mb-2">
                        <span class="text-sm text-gray-400">Cámara inactiva</span>
                    </div>
                    <div id="scan-result" class="hidden p-3 rounded-lg text-center text-sm font-semibold mt-2"></div>
                </div>

                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="p-3 bg-gray-50 border-b">
                        <h3 class="font-semibold text-gray-700 text-sm">Registros de Hoy</h3>
                    </div>
                    <ul id="attendance-list" class="divide-y divide-gray-100 max-h-64 overflow-y-auto">
                        <!-- Logs dinámicos -->
                        <li class="p-4 text-center text-xs text-gray-400">Sin registros hoy</li>
                    </ul>
                </div>

            </div>

        </main>

        <!-- Bottom Navigation (Mobile Friendly) -->
        <nav class="bg-white shadow-up border-t flex justify-around p-2 pb-safe z-20">
            <button onclick="switchTab('tab-generar')" class="nav-btn flex flex-col items-center p-2 text-blue-600 w-full" data-target="tab-generar">
                <i class="fas fa-id-card text-xl mb-1"></i>
                <span class="text-xs font-medium">Carnet</span>
            </button>
            <button onclick="switchTab('tab-gestionar')" class="nav-btn flex flex-col items-center p-2 text-gray-400 w-full" data-target="tab-gestionar">
                <i class="fas fa-users text-xl mb-1"></i>
                <span class="text-xs font-medium">Gestión</span>
            </button>
            <button onclick="switchTab('tab-asistencia')" class="nav-btn flex flex-col items-center p-2 text-gray-400 w-full" data-target="tab-asistencia">
                <i class="fas fa-qrcode text-xl mb-1"></i>
                <span class="text-xs font-medium">Escanear</span>
            </button>
        </nav>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed top-5 right-5 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-xl transform translate-x-full transition-transform duration-300 z-50 flex items-center">
        <i id="toast-icon" class="fas fa-info-circle mr-3"></i>
        <span id="toast-message">Notificación</span>
    </div>

    <script type="module">
        // --- 1. FIREBASE CONFIG & INIT ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, deleteDoc, doc, orderBy, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBo9YlpqRx04DmnGEZ7sw5M07AGyC7eRG4",
            authDomain: "app-asistecia-qr.firebaseapp.com",
            projectId: "app-asistecia-qr",
            storageBucket: "app-asistecia-qr.firebasestorage.app",
            messagingSenderId: "1001987551868",
            appId: "1:1001987551868:web:f1d409d7cfaf962ea90ff9",
            measurementId: "G-FNR6BXHPC3"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Variables Globales del Sistema
        const APP_ID = "asistencia-qr-v1"; // Identificador para la ruta artifacts
        let currentUser = null;
        let html5QrcodeScanner = null;
        let isScanning = false;
        let lastScannedCode = null;
        let allStudentsCache = []; // Caché local para búsquedas rápidas al escanear
        let scanCooldown = false;

        // --- 2. AUTHENTICATION (System Backend) ---
        // Iniciamos sesión anónima en Firebase para tener permisos de lectura/escritura en Firestore
        // El login "admin" es solo una puerta visual.
        async function initAuth() {
            try {
                const userCredential = await signInAnonymously(auth);
                currentUser = userCredential.user;
                console.log("Conectado a Firebase como:", currentUser.uid);
                document.getElementById('db-status').innerHTML = '<i class="fas fa-wifi text-green-500"></i> Sistema Conectado';
                
                // Iniciar listeners una vez autenticado
                startStudentsListener();
                startAttendanceListener();
            } catch (error) {
                console.error("Error Auth:", error);
                document.getElementById('db-status').innerHTML = '<span class="text-red-500">Error de conexión</span>';
            }
        }
        initAuth();

        // --- 3. UI LOGIN LOGIC ---
        const loginForm = document.getElementById('login-form');
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;

            if(u === 'admin' && p === '1234') {
                document.getElementById('login-view').classList.add('hidden');
                document.getElementById('app-view').classList.remove('hidden');
                document.getElementById('app-view').classList.add('flex');
            } else {
                document.getElementById('login-error').classList.remove('hidden');
            }
        });

        window.logout = () => {
            location.reload();
        };

        // --- 4. NAVIGATION LOGIC ---
        window.switchTab = (tabId) => {
            // UI Update
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            
            document.querySelectorAll('.nav-btn').forEach(el => {
                if(el.dataset.target === tabId) {
                    el.classList.add('text-blue-600');
                    el.classList.remove('text-gray-400');
                } else {
                    el.classList.remove('text-blue-600');
                    el.classList.add('text-gray-400');
                }
            });

            // Logic Specifics
            if(tabId === 'tab-asistencia') {
                startScanner();
            } else {
                stopScanner();
            }
        };

        // --- 5. CARNET GENERATION LOGIC ---
        
        // Image Processing (File to Base64)
        let currentPhotoBase64 = "";
        document.getElementById('inp-photo').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if(file) {
                // Validación básica de tamaño (aprox 500KB límite suave)
                if(file.size > 500000) {
                    showToast("La imagen es muy grande. Intenta usar una más pequeña.", "error");
                    // No return, tratamos de procesarla igual pero aviso
                }
                const reader = new FileReader();
                reader.onloadend = function() {
                    currentPhotoBase64 = reader.result;
                    document.getElementById('card-img').src = currentPhotoBase64;
                }
                reader.readAsDataURL(file);
            }
        });

        // Generar QR y Preview
        window.previewCard = () => {
            const data = {
                id: document.getElementById('inp-id').value,
                name: document.getElementById('inp-name').value,
                role: document.getElementById('inp-role').value,
                residence: document.getElementById('inp-residence').value,
                expiry: document.getElementById('inp-expiry').value
            };

            if(!data.id || !data.name) {
                showToast("ID y Nombre son obligatorios", "error");
                return false;
            }

            // Update UI Text
            document.getElementById('card-name').innerText = data.name;
            document.getElementById('card-role').innerText = data.role;
            document.getElementById('card-id').innerText = data.id;
            document.getElementById('card-residence').innerText = data.residence || "N/A";
            document.getElementById('card-expiry').innerText = data.expiry || "Indefinido";

            // Generate QR
            const qrContainer = document.getElementById('card-qrcode');
            qrContainer.innerHTML = ""; // Clear prev
            new QRCode(qrContainer, {
                text: data.id, // El QR contiene SOLO el ID
                width: 80,
                height: 80,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });

            document.getElementById('btn-download').classList.remove('hidden');
            return true;
        };

        // Guardar en Firestore
        document.getElementById('carnet-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if(!currentUser) { showToast("Sin conexión a base de datos", "error"); return; }
            if(!previewCard()) return; // Validar y generar vista primero

            const userData = {
                id_card: document.getElementById('inp-id').value,
                name: document.getElementById('inp-name').value,
                role: document.getElementById('inp-role').value,
                residence: document.getElementById('inp-residence').value,
                expiry: document.getElementById('inp-expiry').value,
                photo: currentPhotoBase64, // Guardamos la foto en base64 (cuidado con el tamaño)
                createdAt: serverTimestamp()
            };

            // Verificar si el ID ya existe (en caché local para evitar lecturas extras o query compleja)
            const exists = allStudentsCache.some(s => s.id_card === userData.id_card);
            if(exists) {
                showToast("¡Este ID ya está registrado!", "error");
                return;
            }

            try {
                // Ruta pública para que todos los admins vean los estudiantes
                const colRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'students');
                await addDoc(colRef, userData);
                showToast("Usuario guardado correctamente", "success");
                // Reset form opcional
                // e.target.reset();
            } catch (err) {
                console.error(err);
                showToast("Error al guardar: " + err.message, "error");
            }
        });

        // Descargar JPG
        window.downloadCardImage = () => {
            const element = document.getElementById('id-card-preview');
            html2canvas(element, { scale: 2, useCORS: true }).then(canvas => {
                const link = document.createElement('a');
                link.download = `carnet-${document.getElementById('inp-id').value}.jpg`;
                link.href = canvas.toDataURL("image/jpeg");
                link.click();
            });
        };

        // --- 6. DATA MANAGEMENT (CRUD) ---
        function startStudentsListener() {
            if (!currentUser) return;
            const colRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'students');
            
            // Query simple, sin orderBy complejo para evitar errores de índice
            onSnapshot(colRef, (snapshot) => {
                const tbody = document.getElementById('users-table-body');
                tbody.innerHTML = "";
                allStudentsCache = []; // Actualizar caché
                
                if(snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-400">No hay usuarios registrados</td></tr>';
                    document.getElementById('user-count').innerText = "0 usuarios";
                    return;
                }

                snapshot.forEach(docSnap => {
                    const student = docSnap.data();
                    student.docId = docSnap.id;
                    allStudentsCache.push(student);

                    const tr = document.createElement('tr');
                    tr.className = "border-b hover:bg-gray-50";
                    tr.innerHTML = `
                        <td class="p-3 flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-gray-200 overflow-hidden">
                                ${student.photo ? `<img src="${student.photo}" class="w-full h-full object-cover">` : '<i class="fas fa-user text-gray-400 p-2"></i>'}
                            </div>
                            <div>
                                <div class="font-bold text-gray-800">${student.name}</div>
                            </div>
                        </td>
                        <td class="p-3 font-mono text-xs">${student.id_card}</td>
                        <td class="p-3"><span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">${student.role}</span></td>
                        <td class="p-3 text-center">
                            <button onclick="deleteUser('${docSnap.id}')" class="text-red-500 hover:bg-red-50 p-2 rounded transition">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                document.getElementById('user-count').innerText = `${allStudentsCache.length} usuarios`;
            }, (error) => {
                console.error("Error obteniendo usuarios:", error);
            });
        }

        window.deleteUser = async (docId) => {
            if(confirm("¿Estás seguro de borrar este usuario?")) {
                try {
                    await deleteDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'students', docId));
                    showToast("Usuario eliminado", "success");
                } catch (e) {
                    showToast("Error al eliminar", "error");
                }
            }
        };

        // --- 7. ATTENDANCE & SCANNER LOGIC ---

        function startScanner() {
            if(html5QrcodeScanner) return; // Ya existe

            // Configurar scanner
            html5QrcodeScanner = new Html5Qrcode("reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            
            html5QrcodeScanner.start(
                { facingMode: "environment" }, 
                config, 
                onScanSuccess
            ).catch(err => {
                console.log("Error iniciando cámara", err);
                document.getElementById('reader').innerHTML = '<p class="text-red-500 text-center p-4">Permiso de cámara denegado o error.</p>';
            });
        }

        function stopScanner() {
            if(html5QrcodeScanner) {
                html5QrcodeScanner.stop().then(() => {
                    html5QrcodeScanner.clear();
                    html5QrcodeScanner = null;
                }).catch(err => console.log(err));
            }
        }

        async function onScanSuccess(decodedText, decodedResult) {
            if(scanCooldown) return;
            scanCooldown = true; // Evitar lecturas múltiples muy rápidas

            // Feedback visual inmediato
            const resDiv = document.getElementById('scan-result');
            resDiv.classList.remove('hidden');
            resDiv.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Procesando ID: ${decodedText}`;
            resDiv.className = "p-3 rounded-lg text-center text-sm font-semibold mt-2 bg-yellow-100 text-yellow-800";

            // 1. Validar si el usuario existe en nuestro sistema (Usando caché local)
            const student = allStudentsCache.find(s => s.id_card === decodedText);

            if(!student) {
                beep(false);
                resDiv.className = "p-3 rounded-lg text-center text-sm font-semibold mt-2 bg-red-100 text-red-800";
                resDiv.innerHTML = `<i class="fas fa-times-circle"></i> ID Desconocido: ${decodedText}`;
                setTimeout(() => { scanCooldown = false; }, 2000);
                return;
            }

            // 2. Validar Anti-Doble Marcado (Consultando logs de hoy en caché o DB)
            // Para simplificar y cumplir regla de "No Complex Queries", filtramos en memoria los logs de hoy
            // que obtenemos del listener de abajo.
            const todayStr = new Date().toLocaleDateString();
            const alreadyChecked = todaysAttendanceCache.some(log => log.studentId === decodedText);

            if(alreadyChecked) {
                beep(false);
                resDiv.className = "p-3 rounded-lg text-center text-sm font-semibold mt-2 bg-orange-100 text-orange-800";
                resDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${student.name} ya marcó hoy.`;
                setTimeout(() => { scanCooldown = false; }, 2500);
                return;
            }

            // 3. Registrar Asistencia
            try {
                beep(true);
                const colRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'attendance');
                await addDoc(colRef, {
                    studentId: decodedText,
                    studentName: student.name,
                    timestamp: serverTimestamp(),
                    dateStr: todayStr, // Campo auxiliar para filtrar fácil
                    role: student.role
                });

                resDiv.className = "p-3 rounded-lg text-center text-sm font-semibold mt-2 bg-green-100 text-green-800";
                resDiv.innerHTML = `<i class="fas fa-check-circle"></i> ¡Bienvenido, ${student.name}!`;

            } catch (error) {
                console.error(error);
                resDiv.innerText = "Error de conexión al guardar.";
            }

            // Reset cooldown
            setTimeout(() => { 
                scanCooldown = false; 
                resDiv.classList.add('hidden');
            }, 3000);
        }

        // Attendance List Management
        let todaysAttendanceCache = [];

        function startAttendanceListener() {
            if (!currentUser) return;
            const colRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'attendance');
            
            // Obtenemos todo (Idealmente usaríamos where('dateStr', '==', today) pero requiere crear indice compuesto si ordenamos)
            // Traemos los últimos 50 registros por simplicidad y filtramos en JS
            const q = query(colRef, orderBy('timestamp', 'desc'), limit(50));

            onSnapshot(q, (snapshot) => {
                const list = document.getElementById('attendance-list');
                list.innerHTML = "";
                todaysAttendanceCache = [];
                const todayStr = new Date().toLocaleDateString();

                if(snapshot.empty) {
                    list.innerHTML = '<li class="p-4 text-center text-xs text-gray-400">Sin registros</li>';
                    return;
                }

                snapshot.forEach(doc => {
                    const log = doc.data();
                    // Filtramos solo los de hoy para el caché de validación
                    // Nota: Firestore Timestamp a Date JS
                    let logDateStr = "N/A";
                    let timeStr = "--:--";
                    if(log.timestamp) {
                        const dateObj = log.timestamp.toDate();
                        logDateStr = dateObj.toLocaleDateString();
                        timeStr = dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        
                        if(logDateStr === todayStr) {
                            todaysAttendanceCache.push(log);
                        }
                    }

                    // Renderizar solo si es hoy (Visualmente)
                    if(logDateStr === todayStr) {
                        const li = document.createElement('li');
                        li.className = "p-3 flex justify-between items-center";
                        li.innerHTML = `
                            <div>
                                <p class="text-sm font-bold text-gray-800">${log.studentName}</p>
                                <p class="text-xs text-gray-500">${log.role} • ID: ${log.studentId}</p>
                            </div>
                            <span class="text-xs font-mono bg-green-50 text-green-600 px-2 py-1 rounded">${timeStr}</span>
                        `;
                        list.appendChild(li);
                    }
                });
            }, (err) => console.log("Error attendance listener", err));
        }

        // --- UTILS ---
        function showToast(msg, type="info") {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toast-icon');
            const txt = document.getElementById('toast-message');
            
            txt.innerText = msg;
            toast.classList.remove('translate-x-full');
            
            if(type === 'error') {
                toast.classList.replace('bg-gray-800', 'bg-red-600');
                icon.className = "fas fa-times-circle mr-3";
            } else if (type === 'success') {
                toast.classList.replace('bg-gray-800', 'bg-green-600');
                icon.className = "fas fa-check-circle mr-3";
            } else {
                toast.classList.replace('bg-red-600', 'bg-gray-800');
                toast.classList.replace('bg-green-600', 'bg-gray-800');
                icon.className = "fas fa-info-circle mr-3";
            }

            setTimeout(() => {
                toast.classList.add('translate-x-full');
            }, 3000);
        }

        function beep(success) {
            const context = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = context.createOscillator();
            const gainNode = context.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(context.destination);

            if(success) {
                oscillator.type = "sine";
                oscillator.frequency.value = 800;
                gainNode.gain.value = 0.1;
                oscillator.start();
                setTimeout(() => oscillator.stop(), 100);
            } else {
                oscillator.type = "sawtooth";
                oscillator.frequency.value = 200;
                gainNode.gain.value = 0.1;
                oscillator.start();
                setTimeout(() => oscillator.stop(), 300);
            }
        }

    </script>
</body>
</html>                                            
        
                                        
