<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Asistencia QR Pro V3</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        /* Corrección de altura para móviles (evita que el menú se corte) */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f3f4f6;
            height: 100vh; /* Fallback */
            height: 100dvh; /* Dynamic Height para móviles */
            overflow: hidden;
        }
        
        .tab-content { display: none; height: 100%; overflow-y: auto; padding-bottom: 80px; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Estilos del Carnet (Ajustado para que no se rompa al descargar) */
        #id-card-preview {
            width: 320px; 
            height: 520px; /* Un poco más alto para dar espacio */
            background: white; 
            position: relative;
            overflow: hidden; 
            border-radius: 16px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin: 0 auto;
        }
        
        .card-header-bg {
            background: linear-gradient(180deg, #2563eb 0%, #1e40af 100%);
            height: 160px; 
            width: 100%; 
            position: absolute; 
            top: 0; 
            left: 0; 
            z-index: 0;
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
        }

        /* Contenedor del scanner */
        #reader { width: 100%; border-radius: 12px; overflow: hidden; position: relative; background: black; }
        
        /* Ocultar barra de scroll fea pero permitir scroll */
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="flex flex-col text-gray-800">

    <div id="login-view" class="absolute inset-0 z-50 flex items-center justify-center bg-gray-100 p-4">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm border border-gray-100">
            <div class="text-center mb-8">
                <div class="bg-blue-600 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-blue-200">
                    <i class="fas fa-qrcode text-3xl text-white"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-800">Control de Acceso</h1>
                <p class="text-gray-500 text-sm mt-1">Identifícate para continuar</p>
            </div>
            
            <form id="login-form" class="space-y-4">
                <input type="text" id="username" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500" placeholder="Usuario">
                <input type="password" id="password" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contraseña">
                <div id="login-error" class="hidden text-red-500 text-xs text-center bg-red-50 p-2 rounded">Credenciales incorrectas</div>
                <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-xl font-semibold hover:bg-blue-700 shadow-lg transition">Iniciar Sesión</button>
            </form>
            <p id="db-status" class="mt-6 text-center text-xs text-gray-400"><i class="fas fa-circle-notch fa-spin"></i> Conectando...</p>
        </div>
    </div>

    <div id="app-view" class="hidden flex-col h-full w-full">
        
        <header class="bg-white border-b px-4 py-3 flex justify-between items-center z-20 shadow-sm shrink-0">
            <h1 class="font-bold text-gray-800 flex items-center gap-2">
                <span class="bg-blue-600 text-white w-7 h-7 flex items-center justify-center rounded text-sm"><i class="fas fa-check"></i></span>
                Asistencia V3
            </h1>
            <button onclick="logout()" class="text-gray-400 hover:text-red-500"><i class="fas fa-power-off"></i></button>
        </header>

        <main class="flex-1 overflow-hidden relative bg-gray-50">
            
            <div id="tab-generar" class="tab-content active hide-scroll">
                <div class="max-w-xl mx-auto p-4 space-y-6">
                    
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                        <h2 class="text-sm font-bold text-gray-700 mb-4 border-b pb-2">Datos del Estudiante</h2>
                        <form id="carnet-form" class="space-y-3">
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="text-[10px] font-bold text-gray-500 uppercase">ID / Documento</label>
                                    <input type="number" id="inp-id" required class="w-full p-2 border rounded bg-gray-50 text-sm outline-none focus:bg-white" placeholder="Ej: 1006418">
                                </div>
                                <div>
                                    <label class="text-[10px] font-bold text-gray-500 uppercase">Rol</label>
                                    <select id="inp-role" class="w-full p-2 border rounded bg-gray-50 text-sm outline-none">
                                        <option value="Estudiante">Estudiante</option>
                                        <option value="Profesor">Profesor</option>
                                        <option value="Admin">Administrativo</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label class="text-[10px] font-bold text-gray-500 uppercase">Nombre Completo</label>
                                <input type="text" id="inp-name" required class="w-full p-2 border rounded bg-gray-50 text-sm outline-none focus:bg-white" placeholder="Ej: Johan Roncancio">
                            </div>

                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="text-[10px] font-bold text-gray-500 uppercase">Sede</label>
                                    <input type="text" id="inp-residence" class="w-full p-2 border rounded bg-gray-50 text-sm outline-none" placeholder="Puerto Rico">
                                </div>
                                <div>
                                    <label class="text-[10px] font-bold text-gray-500 uppercase">Vencimiento</label>
                                    <input type="date" id="inp-expiry" class="w-full p-2 border rounded bg-gray-50 text-sm outline-none">
                                </div>
                            </div>

                            <div>
                                <label class="text-[10px] font-bold text-gray-500 uppercase">Foto</label>
                                <input type="file" id="inp-photo" accept="image/*" class="w-full text-xs text-gray-500 file:mr-2 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-blue-50 file:text-blue-700">
                            </div>

                            <div class="pt-2 flex gap-2">
                                <button type="button" onclick="previewCard()" class="flex-1 bg-gray-100 text-gray-700 py-2 rounded hover:bg-gray-200 text-xs font-bold uppercase">
                                    <i class="fas fa-eye mr-1"></i> Ver
                                </button>
                                <button type="submit" class="flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700 text-xs font-bold uppercase shadow">
                                    <i class="fas fa-save mr-1"></i> Guardar
                                </button>
                            </div>
                        </form>
                    </div>

                    <div class="flex flex-col items-center pb-10">
                        <div id="id-card-wrap" class="mb-4 transform origin-top transition-transform">
                            <div id="id-card-preview">
                                <div class="card-header-bg"></div>
                                
                                <div class="relative z-10 flex flex-col items-center pt-8 h-full">
                                    <h3 class="text-white text-xs font-bold tracking-[0.2em] uppercase opacity-90 mb-6">Identificación Digital</h3>
                                    
                                    <div class="w-32 h-32 rounded-full p-1 bg-white shadow-lg z-20">
                                        <img id="card-img" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' class='h-full w-full text-gray-300' fill='currentColor' viewBox='0 0 24 24'%3E%3Cpath d='M24 20.993V24H0v-2.996A14.977 14.977 0 0112.004 15c4.904 0 9.26 2.354 11.996 5.993zM16.002 8.999a4 4 0 11-8 0 4 4 0 018 0z' /%3E%3C/svg%3E" class="w-full h-full rounded-full object-cover bg-gray-100">
                                    </div>

                                    <div class="text-center mt-4 w-full px-4 z-20">
                                        <h2 id="card-name" class="text-xl font-bold text-gray-800 truncate leading-tight">Nombre Usuario</h2>
                                        <div class="mt-2 flex justify-center">
                                            <span id="card-role" class="bg-blue-100 text-blue-700 text-xs px-4 py-1 rounded-full uppercase font-bold tracking-wide">ESTUDIANTE</span>
                                        </div>
                                    </div>

                                    <div class="mt-6 flex justify-around w-full px-4 text-center">
                                        <div class="flex-1">
                                            <p class="text-[9px] text-gray-400 uppercase font-bold tracking-wider">ID Número</p>
                                            <p id="card-id" class="font-mono text-gray-800 font-bold text-base mt-1">00000000</p>
                                        </div>
                                        <div class="flex-1">
                                            <p class="text-[9px] text-gray-400 uppercase font-bold tracking-wider">Sede</p>
                                            <p id="card-residence" class="text-gray-800 font-bold text-base mt-1 truncate max-w-[100px] mx-auto">-</p>
                                        </div>
                                    </div>

                                    <div class="mt-auto mb-8 bg-white p-2 rounded-xl border border-gray-100 shadow-sm">
                                        <div id="card-qrcode"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="action-buttons" class="hidden flex gap-3 w-full max-w-xs">
                            <button onclick="printCard()" class="flex-1 bg-gray-800 text-white py-3 rounded-full shadow-lg font-bold text-sm hover:bg-gray-900 transition flex items-center justify-center gap-2">
                                <i class="fas fa-print"></i> Imprimir
                            </button>
                            <button onclick="downloadCardImage()" class="flex-1 bg-green-600 text-white py-3 rounded-full shadow-lg font-bold text-sm hover:bg-green-700 transition flex items-center justify-center gap-2">
                                <i class="fas fa-download"></i> Descargar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-gestionar" class="tab-content hide-scroll">
                <div class="max-w-xl mx-auto p-4">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                        <div class="p-4 border-b bg-gray-50">
                            <h2 class="font-bold text-gray-800 mb-2">Base de Datos</h2>
                            <div class="relative">
                                <i class="fas fa-search absolute left-3 top-3 text-gray-400 text-xs"></i>
                                <input type="text" id="search-input" onkeyup="filterUsers()" placeholder="Buscar estudiante..." 
                                    class="w-full pl-8 pr-4 py-2 border rounded-lg text-sm bg-white outline-none focus:ring-1 focus:ring-blue-500">
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm text-gray-600">
                                <thead class="bg-gray-100 text-xs uppercase font-bold text-gray-500">
                                    <tr>
                                        <th class="p-3">Estudiante</th>
                                        <th class="p-3 text-center">Acción</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table-body" class="divide-y divide-gray-100">
                                    <tr><td colspan="2" class="p-4 text-center text-xs">Cargando...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-asistencia" class="tab-content hide-scroll">
                <div class="max-w-md mx-auto p-4 space-y-4">
                    
                    <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-4">
                        <h2 class="text-center font-bold text-gray-800 mb-2">Escanear Entrada</h2>
                        
                        <div class="relative rounded-lg overflow-hidden bg-black aspect-square max-h-64 mx-auto border-2 border-gray-100">
                            <div id="reader" class="h-full w-full object-cover"></div>
                        </div>
                        
                        <div id="scan-result" class="hidden mt-3 p-3 rounded-lg text-sm font-bold text-center"></div>
                    </div>

                    <div class="bg-white p-4 rounded-xl shadow-sm border flex gap-2">
                        <input type="number" id="manual-id" placeholder="ID Manual" class="flex-1 p-2 border rounded-lg text-center text-sm outline-none">
                        <button onclick="manualAttendance()" class="bg-gray-800 text-white px-4 rounded-lg"><i class="fas fa-check"></i></button>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 flex flex-col h-64">
                        <div class="p-3 border-b bg-gray-50 flex justify-between items-center">
                            <span class="font-bold text-xs text-gray-600">ASISTENCIA HOY</span>
                            <button onclick="exportToCSV()" class="text-[10px] bg-green-100 text-green-700 px-2 py-1 rounded font-bold">
                                <i class="fas fa-file-excel"></i> CSV
                            </button>
                        </div>
                        <ul id="attendance-list" class="divide-y divide-gray-100 overflow-y-auto flex-1 p-2">
                            <li class="p-4 text-center text-xs text-gray-400">Esperando registros...</li>
                        </ul>
                    </div>
                </div>
            </div>

        </main>

        <nav class="bg-white border-t flex justify-around p-2 pb-safe fixed bottom-0 left-0 w-full z-40 shadow-[0_-5px_10px_rgba(0,0,0,0.05)] h-[70px]">
            <button onclick="switchTab('tab-generar')" class="nav-btn group w-full flex flex-col items-center justify-center text-blue-600" data-target="tab-generar">
                <i class="fas fa-id-card text-xl mb-1 transition-transform group-active:scale-90"></i>
                <span class="text-[10px] font-bold">Carnet</span>
            </button>
            <button onclick="switchTab('tab-gestionar')" class="nav-btn group w-full flex flex-col items-center justify-center text-gray-400" data-target="tab-gestionar">
                <i class="fas fa-users-cog text-xl mb-1 transition-transform group-active:scale-90"></i>
                <span class="text-[10px] font-bold">Gestor</span>
            </button>
            <button onclick="switchTab('tab-asistencia')" class="nav-btn group w-full flex flex-col items-center justify-center text-gray-400" data-target="tab-asistencia">
                <div class="bg-blue-600 text-white rounded-full p-2 -mt-4 shadow-lg border-4 border-white">
                    <i class="fas fa-qrcode text-lg"></i>
                </div>
                <span class="text-[10px] font-bold mt-1">Scan</span>
            </button>
        </nav>

    </div>

    <div id="toast" class="hidden fixed top-5 right-5 z-[100] bg-gray-900 text-white px-4 py-3 rounded-lg shadow-2xl flex items-center gap-3 animate-bounce-in">
        <i id="toast-icon" class="fas fa-info-circle"></i>
        <div>
            <h4 id="toast-title" class="font-bold text-xs">Info</h4>
            <p id="toast-message" class="text-[10px] text-gray-300">Mensaje</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, deleteDoc, doc, orderBy, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBo9YlpqRx04DmnGEZ7sw5M07AGyC7eRG4",
            authDomain: "app-asistecia-qr.firebaseapp.com",
            projectId: "app-asistecia-qr",
            storageBucket: "app-asistecia-qr.firebasestorage.app",
            messagingSenderId: "1001987551868",
            appId: "1:1001987551868:web:f1d409d7cfaf962ea90ff9"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const APP_ID = "asistencia-v3"; // Versionado para limpiar datos viejos si quieres

        let allStudents = [];
        let todaysAttendance = [];
        let html5QrcodeScanner = null;
        let scanCooldown = false;

        // AUTH
        signInAnonymously(auth).then(() => {
            document.getElementById('db-status').innerHTML = '<span class="text-green-500 font-bold">● Conectado</span>';
            loadData();
        }).catch(e => console.error(e));

        // UI LOGIC
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            if(u === 'admin' && p === '1234') {
                document.getElementById('login-view').classList.add('hidden');
                document.getElementById('app-view').classList.remove('hidden');
                document.getElementById('app-view').classList.add('flex');
            } else {
                document.getElementById('login-error').classList.remove('hidden');
            }
        });

        window.logout = () => location.reload();

        window.switchTab = (tabId) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            
            document.querySelectorAll('.nav-btn').forEach(el => {
                if(el.dataset.target === tabId) el.classList.add('text-blue-600');
                else el.classList.remove('text-blue-600');
            });

            if(tabId === 'tab-asistencia') startScanner();
            else stopScanner();
        };

        // --- CARNET LOGIC (MEJORADA) ---
        let photoBase64 = "";
        document.getElementById('inp-photo').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(file) {
                const reader = new FileReader();
                reader.onloadend = () => {
                    photoBase64 = reader.result;
                    document.getElementById('card-img').src = photoBase64;
                };
                reader.readAsDataURL(file);
            }
        });

        window.previewCard = () => {
            const id = document.getElementById('inp-id').value;
            const name = document.getElementById('inp-name').value;
            const role = document.getElementById('inp-role').value;
            const res = document.getElementById('inp-residence').value;

            if(!id || !name) return showToast("Faltan datos", "ID y Nombre son obligatorios", "error");

            document.getElementById('card-name').innerText = name;
            document.getElementById('card-role').innerText = role;
            document.getElementById('card-id').innerText = id;
            document.getElementById('card-residence').innerText = res || "General";

            // Limpiar QR anterior
            document.getElementById('card-qrcode').innerHTML = "";
            
            // Generar QR con tamaño fijo y colores simples para evitar errores visuales
            new QRCode(document.getElementById('card-qrcode'), {
                text: id,
                width: 90,
                height: 90,
                colorDark : "#1e40af", // Azul oscuro
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });

            document.getElementById('action-buttons').classList.remove('hidden');
            document.getElementById('action-buttons').classList.add('flex');
        };

        // DESCARGAR IMAGEN (Corrección de distorsión)
        window.downloadCardImage = () => {
            const element = document.getElementById('id-card-preview');
            
            // Forzar renderizado de alta calidad
            html2canvas(element, { 
                scale: 3, // Mayor resolución
                useCORS: true, 
                backgroundColor: "#ffffff",
                logging: false,
                onclone: (clonedDoc) => {
                    // Asegurar que el clon tenga las fuentes visibles y estilos computados
                    const clonedEl = clonedDoc.getElementById('id-card-preview');
                    clonedEl.style.transform = 'none'; // Quitar transformaciones en la captura
                }
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `Carnet_${document.getElementById('card-id').innerText}.jpg`;
                link.href = canvas.toDataURL("image/jpeg", 0.95);
                link.click();
            });
        };

        // IMPRIMIR CARNET
        window.printCard = () => {
            const element = document.getElementById('id-card-preview');
            html2canvas(element, { scale: 3 }).then(canvas => {
                const imgData = canvas.toDataURL("image/png");
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <html>
                        <head><title>Imprimir Carnet</title></head>
                        <body style="display:flex; justify-content:center; align-items:center; height:100vh; margin:0;">
                            <img src="${imgData}" style="max-height:90vh; border:1px solid #ccc;"/>
                            <script>setTimeout(() => { window.print(); window.close(); }, 500);<\/script>
                        </body>
                    </html>
                `);
                printWindow.document.close();
            });
        };

        // GUARDAR EN FIREBASE
        document.getElementById('carnet-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            previewCard();
            
            const id = document.getElementById('inp-id').value;
            // Verificar duplicados en cache local
            if(allStudents.some(s => s.id_card == id)) return showToast("Error", "Este ID ya está registrado", "error");

            try {
                await addDoc(collection(db, 'artifacts', APP_ID, 'students'), {
                    id_card: id,
                    name: document.getElementById('inp-name').value,
                    role: document.getElementById('inp-role').value,
                    photo: photoBase64, // Nota: Base64 llena rápido Firestore (OK para pruebas)
                    createdAt: serverTimestamp()
                });
                showToast("Guardado", "Estudiante registrado", "success");
                document.getElementById('carnet-form').reset();
                photoBase64 = "";
            } catch (err) { console.error(err); }
        });

        // --- GESTIÓN DE DATOS ---
        function loadData() {
            // Estudiantes
            onSnapshot(collection(db, 'artifacts', APP_ID, 'students'), (snap) => {
                allStudents = [];
                snap.forEach(d => allStudents.push({ ...d.data(), uid: d.id }));
                renderStudents(allStudents);
            });

            // Asistencia (Solo hoy)
            const todayStr = new Date().toLocaleDateString();
            const q = query(collection(db, 'artifacts', APP_ID, 'attendance'), orderBy('timestamp', 'desc'), limit(50));
            onSnapshot(q, (snap) => {
                todaysAttendance = [];
                snap.forEach(d => {
                    const data = d.data();
                    if(data.dateStr === todayStr) todaysAttendance.push(data);
                });
                renderAttendance();
            });
        }

        window.renderStudents = (list) => {
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = list.length ? "" : '<tr><td colspan="2" class="p-4 text-center text-xs">Sin datos</td></tr>';
            
            list.forEach(s => {
                tbody.innerHTML += `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-3 flex items-center gap-3">
                            <img src="${s.photo || 'https://via.placeholder.com/40'}" class="w-8 h-8 rounded-full object-cover bg-gray-200">
                            <div>
                                <div class="font-bold text-gray-800 text-xs">${s.name}</div>
                                <div class="text-[10px] text-gray-500">ID: ${s.id_card}</div>
                            </div>
                        </td>
                        <td class="p-3 text-center">
                            <button onclick="deleteUser('${s.uid}')" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
        };

        window.filterUsers = () => {
            const txt = document.getElementById('search-input').value.toLowerCase();
            const filtered = allStudents.filter(s => s.name.toLowerCase().includes(txt) || s.id_card.toString().includes(txt));
            renderStudents(filtered);
        };

        window.deleteUser = async (uid) => {
            if(confirm("¿Borrar usuario?")) await deleteDoc(doc(db, 'artifacts', APP_ID, 'students', uid));
        }

        // --- ASISTENCIA ---
        function startScanner() {
            if(html5QrcodeScanner) return;
            html5QrcodeScanner = new Html5Qrcode("reader");
            html5QrcodeScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, onScan);
        }
        function stopScanner() {
            if(html5QrcodeScanner) { html5QrcodeScanner.stop().then(() => html5QrcodeScanner.clear()); html5QrcodeScanner = null; }
        }

        window.manualAttendance = () => {
            const id = document.getElementById('manual-id').value;
            if(id) { onScan(id); document.getElementById('manual-id').value = ""; }
        }

        async function onScan(code) {
            if(scanCooldown) return;
            scanCooldown = true;
            
            const student = allStudents.find(s => s.id_card == code);
            const resDiv = document.getElementById('scan-result');
            resDiv.classList.remove('hidden');

            if(!student) {
                resDiv.className = "mt-3 p-3 rounded-lg text-sm font-bold text-center bg-red-100 text-red-600";
                resDiv.innerHTML = "ID No Encontrado";
            } else if (todaysAttendance.some(a => a.studentId == code)) {
                resDiv.className = "mt-3 p-3 rounded-lg text-sm font-bold text-center bg-yellow-100 text-yellow-700";
                resDiv.innerHTML = "Ya registró asistencia hoy";
            } else {
                resDiv.className = "mt-3 p-3 rounded-lg text-sm font-bold text-center bg-green-100 text-green-700";
                resDiv.innerHTML = `Bienvenido, ${student.name.split(' ')[0]}`;
                
                await addDoc(collection(db, 'artifacts', APP_ID, 'attendance'), {
                    studentId: code,
                    studentName: student.name,
                    role: student.role,
                    dateStr: new Date().toLocaleDateString(),
                    timestamp: serverTimestamp()
                });
            }

            setTimeout(() => { scanCooldown = false; resDiv.classList.add('hidden'); }, 2000);
        }

        function renderAttendance() {
            const list = document.getElementById('attendance-list');
            list.innerHTML = todaysAttendance.length ? "" : '<li class="p-4 text-center text-xs text-gray-400">Hoy no hay registros aún</li>';
            
            todaysAttendance.forEach(a => {
                const time = a.timestamp ? a.timestamp.toDate().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '...';
                list.innerHTML += `
                    <li class="p-3 flex justify-between items-center hover:bg-gray-50">
                        <div>
                            <p class="font-bold text-gray-800 text-xs">${a.studentName}</p>
                            <p class="text-[10px] text-gray-500">${a.role}</p>
                        </div>
                        <span class="text-xs font-mono font-bold text-blue-600 bg-blue-50 px-2 rounded">${time}</span>
                    </li>
                `;
            });
        }

        window.exportToCSV = () => {
            if(!todaysAttendance.length) return showToast("Vacio", "No hay datos hoy", "error");
            let csv = "Nombre,Rol,Hora\n" + todaysAttendance.map(a => 
                `${a.studentName},${a.role},${a.timestamp.toDate().toLocaleTimeString()}`
            ).join("\n");
            
            const link = document.createElement("a");
            link.href = "data:text/csv;charset=utf-8," + encodeURI(csv);
            link.download = "Asistencia.csv";
            link.click();
        }

        // --- UTILS ---
        function showToast(title, msg, type) {
            const t = document.getElementById('toast');
            document.getElementById('toast-title').innerText = title;
            document.getElementById('toast-message').innerText = msg;
            t.classList.remove('hidden');
            setTimeout(() => t.classList.add('hidden'), 3000);
        }
    </script>
</body>
</html>                                            

                                
                                            
